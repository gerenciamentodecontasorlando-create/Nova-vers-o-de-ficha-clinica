<script>
// --------- UTILIDADES GERAIS ---------
function mostrarStatus(id, msg) {
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent = msg;
  if (!msg) return;
  setTimeout(() => {
    el.textContent = "";
  }, 2500);
}

function trocarSecao(idSecao, botao) {
  document.querySelectorAll(".section").forEach(sec => {
    sec.classList.remove("active");
  });
  document.getElementById(idSecao).classList.add("active");

  document.querySelectorAll(".tab-btn").forEach(btn => {
    btn.classList.remove("active");
  });
  if (botao) botao.classList.add("active");
}

// --------- CADASTRO ---------
function salvarCadastro() {
  const dados = {
    nome: document.getElementById("profNome").value || "",
    profissao: document.getElementById("profProfissao").value || "",
    especialidade: document.getElementById("profEspecialidade").value || "",
    conselho: document.getElementById("profConselho").value || "",
    telefone: document.getElementById("profTelefone").value || "",
    endereco: document.getElementById("profEndereco").value || "",
    cidade: document.getElementById("profCidade").value || "",
    login: document.getElementById("profLogin").value || "",
    senha: document.getElementById("profSenha").value || ""
  };
  localStorage.setItem("btx_profissional", JSON.stringify(dados));
  mostrarStatus("statusCadastro", "Cadastro salvo com sucesso.");
}

function carregarCadastro() {
  const salvo = localStorage.getItem("btx_profissional");
  if (!salvo) return;
  try {
    const d = JSON.parse(salvo);
    document.getElementById("profNome").value = d.nome || "";
    document.getElementById("profProfissao").value = d.profissao || "";
    document.getElementById("profEspecialidade").value = d.especialidade || "";
    document.getElementById("profConselho").value = d.conselho || "";
    document.getElementById("profTelefone").value = d.telefone || "";
    document.getElementById("profEndereco").value = d.endereco || "";
    document.getElementById("profCidade").value = d.cidade || "";
    document.getElementById("profLogin").value = d.login || "";
    document.getElementById("profSenha").value = d.senha || "";
  } catch (e) {
    console.error(e);
  }
}

function limparCadastro() {
  ["profNome","profProfissao","profEspecialidade","profConselho",
    "profTelefone","profEndereco","profCidade","profLogin","profSenha"
  ].forEach(id => document.getElementById(id).value = "");
  mostrarStatus("statusCadastro", "Cadastro limpo (não esqueça de salvar novamente).");
}

// --------- FICHA CLÍNICA ---------
function salvarFicha() {
  const f = {
    nome: document.getElementById("pacNome").value || "",
    nasc: document.getElementById("pacNascimento").value || "",
    mae: document.getElementById("pacMae").value || "",
    tel: document.getElementById("pacTelefone").value || "",
    end: document.getElementById("pacEndereco").value || "",
    queixa: document.getElementById("pacQueixa").value || "",
    anamnese: document.getElementById("pacAnamnese").value || "",
    procedimentos: document.getElementById("pacProcedimentos").value || ""
  };
  localStorage.setItem("btx_ficha", JSON.stringify(f));
  mostrarStatus("statusFicha", "Ficha clínica salva.");
}

function carregarFicha() {
  const salvo = localStorage.getItem("btx_ficha");
  if (!salvo) return;
  try {
    const f = JSON.parse(salvo);
    document.getElementById("pacNome").value = f.nome || "";
    document.getElementById("pacNascimento").value = f.nasc || "";
    document.getElementById("pacMae").value = f.mae || "";
    document.getElementById("pacTelefone").value = f.tel || "";
    document.getElementById("pacEndereco").value = f.end || "";
    document.getElementById("pacQueixa").value = f.queixa || "";
    document.getElementById("pacAnamnese").value = f.anamnese || "";
    document.getElementById("pacProcedimentos").value = f.procedimentos || "";
  } catch (e) {
    console.error(e);
  }
}

function limparFicha() {
  ["pacNome","pacNascimento","pacMae","pacTelefone","pacEndereco",
    "pacQueixa","pacAnamnese","pacProcedimentos"
  ].forEach(id => document.getElementById(id).value = "");
  mostrarStatus("statusFicha", "Ficha clínica limpa.");
}

// --------- RECEITUÁRIO ---------
function addMedicamento(txt) {
  const campo = document.getElementById("recPrescricao");
  if (!campo.value) {
    campo.value = txt + " – ";
  } else {
    campo.value += "\n" + txt + " – ";
  }
  campo.focus();
}

function salvarReceituario() {
  const r = {
    paciente: document.getElementById("recPaciente").value || "",
    data: document.getElementById("recData").value || "",
    prescricao: document.getElementById("recPrescricao").value || "",
    orientacoes: document.getElementById("recOrientacoes").value || "",
    cidade: document.getElementById("recCidade").value || ""
  };
  localStorage.setItem("btx_receituario", JSON.stringify(r));
  mostrarStatus("statusReceituario", "Receituário salvo.");
}

function carregarReceituario() {
  const salvo = localStorage.getItem("btx_receituario");
  if (!salvo) return;
  try {
    const r = JSON.parse(salvo);
    document.getElementById("recPaciente").value = r.paciente || "";
    document.getElementById("recData").value = r.data || "";
    document.getElementById("recPrescricao").value = r.prescricao || "";
    document.getElementById("recOrientacoes").value = r.orientacoes || "";
    document.getElementById("recCidade").value = r.cidade || "";
  } catch (e) {
    console.error(e);
  }
}

function limparReceituario() {
  ["recPaciente","recData","recPrescricao","recOrientacoes","recCidade"]
    .forEach(id => document.getElementById(id).value = "");
  mostrarStatus("statusReceituario", "Receituário limpo.");
}

// --------- ATESTADO ---------
function salvarAtestado() {
  const a = {
    paciente: document.getElementById("atPaciente").value || "",
    doc: document.getElementById("atDocumento").value || "",
    cid: document.getElementById("atCID").value || "",
    dias: document.getElementById("atDias").value || "",
    data: document.getElementById("atData").value || "",
    cidade: document.getElementById("atCidade").value || "",
    obs: document.getElementById("atObs").value || ""
  };
  localStorage.setItem("btx_atestado", JSON.stringify(a));
  mostrarStatus("statusAtestado", "Atestado salvo.");
}

function carregarAtestado() {
  const salvo = localStorage.getItem("btx_atestado");
  if (!salvo) return;
  try {
    const a = JSON.parse(salvo);
    document.getElementById("atPaciente").value = a.paciente || "";
    document.getElementById("atDocumento").value = a.doc || "";
    document.getElementById("atCID").value = a.cid || "";
    document.getElementById("atDias").value = a.dias || "";
    document.getElementById("atData").value = a.data || "";
    document.getElementById("atCidade").value = a.cidade || "";
    document.getElementById("atObs").value = a.obs || "";
  } catch (e) {
    console.error(e);
  }
}

function limparAtestado() {
  ["atPaciente","atDocumento","atCID","atDias","atData","atCidade","atObs"]
    .forEach(id => document.getElementById(id).value = "");
  mostrarStatus("statusAtestado", "Atestado limpo.");
}

// --------- ORÇAMENTO ---------
function adicionarItemOrcamento(item = {}) {
  const corpo = document.getElementById("orcCorpo");
  const tr = document.createElement("tr");
  tr.className = "orc-item-row";

  tr.innerHTML = `
    <td><input type="text" class="orc-desc" placeholder="Procedimento" value="${item.desc || ""}"></td>
    <td><input type="number" class="orc-qtd" min="1" value="${item.qtd || 1}"></td>
    <td><input type="number" class="orc-valor" min="0" step="0.01" value="${item.valor || ""}"></td>
    <td><input type="text" class="orc-subtotal" readonly></td>
  `;

  corpo.appendChild(tr);
  tr.querySelectorAll(".orc-qtd, .orc-valor").forEach(inp => {
    inp.addEventListener("input", atualizarTotais);
  });
  atualizarTotais();
}

function atualizarTotais() {
  let total = 0;
  document.querySelectorAll(".orc-item-row").forEach(row => {
    const qtd = parseFloat((row.querySelector(".orc-qtd").value || "0").replace(",", ".")) || 0;
    const valor = parseFloat((row.querySelector(".orc-valor").value || "0").replace(",", ".")) || 0;
    const subtotal = qtd * valor;
    row.querySelector(".orc-subtotal").value = subtotal.toFixed(2).replace(".", ",");
    total += subtotal;
  });
  document.getElementById("orcTotal").textContent = total.toFixed(2).replace(".", ",");
}

function salvarOrcamento() {
  const dados = {
    paciente: document.getElementById("orcPaciente").value || "",
    validade: document.getElementById("orcValidade").value || "",
    obs: document.getElementById("orcObs").value || "",
    itens: []
  };

  document.querySelectorAll(".orc-item-row").forEach(row => {
    const desc = row.querySelector(".orc-desc").value || "";
    const qtd = row.querySelector(".orc-qtd").value || "";
    const valor = row.querySelector(".orc-valor").value || "";
    if (desc || valor) {
      dados.itens.push({ desc, qtd, valor });
    }
  });

  localStorage.setItem("btx_orcamento", JSON.stringify(dados));
  mostrarStatus("statusOrcamento", "Orçamento salvo.");
}

function carregarOrcamento() {
  const salvo = localStorage.getItem("btx_orcamento");
  if (!salvo) {
    adicionarItemOrcamento();
    return;
  }
  try {
    const d = JSON.parse(salvo);
    document.getElementById("orcPaciente").value = d.paciente || "";
    document.getElementById("orcValidade").value = d.validade || "";
    document.getElementById("orcObs").value = d.obs || "";
    document.getElementById("orcCorpo").innerHTML = "";
    if (d.itens && d.itens.length) {
      d.itens.forEach(it => adicionarItemOrcamento(it));
    } else {
      adicionarItemOrcamento();
    }
    atualizarTotais();
  } catch (e) {
    console.error(e);
    adicionarItemOrcamento();
  }
}

function limparItensOrcamento() {
  document.getElementById("orcCorpo").innerHTML = "";
  adicionarItemOrcamento();
  atualizarTotais();
}

function limparOrcamento() {
  document.getElementById("orcPaciente").value = "";
  document.getElementById("orcValidade").value = "";
  document.getElementById("orcObs").value = "";
  limparItensOrcamento();
  mostrarStatus("statusOrcamento", "Orçamento limpo.");
}

// --------- GERAR PDF (AGORA LEVA OS VALORES) ---------
function gerarPDF(secaoId) {
  const cadastroSalvo = JSON.parse(localStorage.getItem("btx_profissional") || "{}");

  function nl2br(txt) {
    return (txt || "").replace(/\n/g, "<br>");
  }

  const cabecalhoProf = `
    <div style="text-align:center; margin-bottom:16px; font-family:sans-serif;">
      <div style="font-size:18px; font-weight:bold;">${cadastroSalvo.nome || ""}</div>
      <div style="font-size:14px;">
        ${cadastroSalvo.profissao || ""}${cadastroSalvo.especialidade ? " - " + cadastroSalvo.especialidade : ""}
      </div>
      <div style="font-size:13px;">${cadastroSalvo.conselho || ""}</div>
      <div style="font-size:12px; margin-top:4px;">${cadastroSalvo.endereco || ""}</div>
      <div style="font-size:12px;">${cadastroSalvo.cidade || ""}</div>
      <div style="font-size:12px;">${cadastroSalvo.telefone || ""}</div>
      <hr style="margin-top:12px;">
    </div>
  `;

  let corpo = "";

  if (secaoId === "sec-ficha") {
    const nome = document.getElementById("pacNome").value;
    const nasc = document.getElementById("pacNascimento").value;
    const mae = document.getElementById("pacMae").value;
    const tel = document.getElementById("pacTelefone").value;
    const end = document.getElementById("pacEndereco").value;
    const queixa = document.getElementById("pacQueixa").value;
    const anamnese = document.getElementById("pacAnamnese").value;
    const proc = document.getElementById("pacProcedimentos").value;

    corpo = `
      <h2>Ficha Clínica</h2>
      <p><strong>Paciente:</strong> ${nome || ""}</p>
      <p><strong>Data de nascimento:</strong> ${nasc || ""}</p>
      <p><strong>Nome da mãe:</strong> ${mae || ""}</p>
      <p><strong>Telefone / WhatsApp:</strong> ${tel || ""}</p>
      <p><strong>Endereço:</strong> ${end || ""}</p>
      <hr>
      <p><strong>Queixa principal:</strong><br>${nl2br(queixa)}</p>
      <p><strong>Anamnese / SOAP:</strong><br>${nl2br(anamnese)}</p>
      <p><strong>Procedimentos realizados:</strong><br>${nl2br(proc)}</p>
    `;
  } else if (secaoId === "sec-receituario") {
    const salvoRec = JSON.parse(localStorage.getItem("btx_receituario") || "{}");
    const paciente = document.getElementById("recPaciente").value || salvoRec.paciente || "";
    const data = document.getElementById("recData").value || salvoRec.data || "";
    const presc = document.getElementById("recPrescricao").value || salvoRec.prescricao || "";
    const ori = document.getElementById("recOrientacoes").value || salvoRec.orientacoes || "";
    const cidade = document.getElementById("recCidade").value || salvoRec.cidade || cadastroSalvo.cidade || "";

    corpo = `
      <h2>Receituário</h2>
      <p><strong>Paciente:</strong> ${paciente}</p>
      <p><strong>Data:</strong> ${data}</p>
      <hr>
      <p><strong>Prescrição:</strong><br>${nl2br(presc)}</p>
      <p><strong>Orientações:</strong><br>${nl2br(ori)}</p>
      <br>
      <p>${cidade}</p>
    `;
  } else if (secaoId === "sec-atestado") {
    const salvoAt = JSON.parse(localStorage.getItem("btx_atestado") || "{}");
    const paciente = document.getElementById("atPaciente").value || salvoAt.paciente || "";
    const doc = document.getElementById("atDocumento").value || salvoAt.doc || "";
    const cid = document.getElementById("atCID").value || salvoAt.cid || "";
    const dias = document.getElementById("atDias").value || salvoAt.dias || "";
    const data = document.getElementById("atData").value || salvoAt.data || "";
    const cidade = document.getElementById("atCidade").value || salvoAt.cidade || cadastroSalvo.cidade || "";
    const obs = document.getElementById("atObs").value || salvoAt.obs || "";

    corpo = `
      <h2 style="text-align:center; margin-bottom:16px;">Atestado</h2>
      <p>Certifico, para os devidos fins, que o(a) paciente:</p>
      <p><strong>Nome:</strong> ${paciente}</p>
      <p><strong>Documento:</strong> ${doc}</p>
      ${cid ? `<p><strong>CID:</strong> ${cid}</p>` : ""}
      <p>necessita de <strong>${dias || "____"}</strong> dia(s) de afastamento das suas atividades habituais.</p>
      <p><strong>Data:</strong> ${data}</p>
      <p><strong>Cidade/UF:</strong> ${cidade}</p>
      ${obs ? `<p><strong>Observações:</strong><br>${nl2br(obs)}</p>` : ""}
    `;
  } else if (secaoId === "sec-orcamento") {
    atualizarTotais(); // garante subtotais atualizados

    const salvoOrc = JSON.parse(localStorage.getItem("btx_orcamento") || "{}");
    const paciente = document.getElementById("orcPaciente").value || salvoOrc.paciente || "";
    const validade = document.getElementById("orcValidade").value || salvoOrc.validade || "";
    const obs = document.getElementById("orcObs").value || salvoOrc.obs || "";
    const total = document.getElementById("orcTotal").textContent || "0,00";

    let linhas = "";
    document.querySelectorAll(".orc-item-row").forEach((row) => {
      const desc = row.querySelector(".orc-desc").value;
      const qtd = row.querySelector(".orc-qtd").value;
      const valor = row.querySelector(".orc-valor").value;
      const subtotal = row.querySelector(".orc-subtotal").value;
      if (desc || valor) {
        linhas += `
          <tr>
            <td>${desc || ""}</td>
            <td style="text-align:center;">${qtd || ""}</td>
            <td style="text-align:right;">${valor || ""}</td>
            <td style="text-align:right;">${subtotal || ""}</td>
          </tr>
        `;
      }
    });

    corpo = `
      <h2>Orçamento de Tratamento</h2>
      <p><strong>Paciente:</strong> ${paciente}</p>
      <p><strong>Validade:</strong> ${validade}</p>
      <table style="width:100%; border-collapse:collapse; margin-top:10px;">
        <thead>
          <tr>
            <th style="border:1px solid #444; padding:4px; text-align:left;">Procedimento</th>
            <th style="border:1px solid #444; padding:4px; text-align:center;">Qtd.</th>
            <th style="border:1px solid #444; padding:4px; text-align:right;">Valor unitário (R$)</th>
            <th style="border:1px solid #444; padding:4px; text-align:right;">Subtotal (R$)</th>
          </tr>
        </thead>
        <tbody>
          ${linhas || `<tr><td colspan="4" style="border:1px solid #444; padding:4px;">Sem itens lançados.</td></tr>`}
        </tbody>
      </table>
      <p style="text-align:right; margin-top:10px;">
        <strong>Total geral:</strong> R$ ${total}
      </p>
      ${obs ? `<p><strong>Observações / Condições de pagamento:</strong><br>${nl2br(obs)}</p>` : ""}
    `;
  } else {
    alert("Seção inválida para gerar PDF.");
    return;
  }

  const conteudo = `
    <html>
      <head>
        <meta charset="UTF-8">
        <title>Documento</title>
        <style>
          body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            margin: 24px;
            font-size: 13px;
          }
          h2 {
            margin: 0 0 8px 0;
          }
          p {
            margin: 4px 0;
          }
          table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
          }
          th, td {
            border: 1px solid #444;
            padding: 4px;
            font-size: 12px;
          }
          .assinatura {
            margin-top: 40px;
            text-align: center;
            font-size: 12px;
          }
          .assinatura hr {
            width: 60%;
          }
        </style>
      </head>
      <body>
        ${cabecalhoProf}
        ${corpo}
        <div class="assinatura">
          <hr>
          <div>${cadastroSalvo.nome || ""}</div>
          <div>
            ${cadastroSalvo.profissao || ""}${cadastroSalvo.especialidade ? " - " + cadastroSalvo.especialidade : ""}
          </div>
          <div>${cadastroSalvo.conselho || ""}</div>
        </div>
      </body>
    </html>
  `;

  const janela = window.open("", "_blank");
  janela.document.open();
  janela.document.write(conteudo);
  janela.document.close();
  janela.focus();
  janela.print();
}

// --------- INICIALIZAÇÃO + SERVICE WORKER PWA ---------
window.addEventListener("load", () => {
  carregarCadastro();
  carregarFicha();
  carregarReceituario();
  carregarAtestado();
  carregarOrcamento();

  if ("serviceWorker" in navigator) {
    navigator.serviceWorker
      .register("sw.js")
      .catch(err => console.log("SW erro:", err));
  }
});
</script>
